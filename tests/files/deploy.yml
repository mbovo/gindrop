version: "3.3"
services:

  redis:
    deploy:
      replicas: 1
      placement:
        constraints:
          - engine.labels.com.facilitylive.devel==true
    image: redis:4.0.1-alpine
    networks:
      - flservice
    ports:
      - "6379:6379"
    volumes:
      - type: bind
        source: /exported_01/docker_01/redis
        target: /data

  auth:
    image: docker.facilitylive.int/flcloud/fl-cloud-authserver:1.0.0-SNAPSHOT
    networks:
      - flservice
      - flcloud-common_consulclient
      - traefik
    ports:
      - "8080:8080"
      - "5008:5006"
    secrets:
      - source: authserver_privkey
        target: /opt/fl-cloud-authserver.jks
    environment:
      - JAVA_OPTS=-Dspring.cloud.consul.host=flcloud-common_consul
    deploy:
      replicas: 1
      placement:
        constraints:
          - engine.labels.com.facilitylive.devel==true
      restart_policy:
        delay: 10s
        window: 10s
      labels:
        traefik.port: 8080
        traefik.frontend.rule: "HostRegexp:{subdomain:.*}.cloud.facilitylive.int; PathPrefixStrip:/api/fl-authserver; AddPrefix:/fl-authserver"
        traefik.enable: "true"
        traefik.docker.network: "traefik"

  ui:
    image: docker.facilitylive.int/flcloud/fl-cloud-ui:1.0.0-SNAPSHOT
    networks:
      - flservice
      - flcloud-common_consulclient
      - traefik
    ports:
      - "8081:8080"
    secrets:
      - source: authserver_pubkey
        target: /opt/fl-cloud-authserver.pub
    environment:
      - JAVA_OPTS=-Dspring.cloud.consul.host=flcloud-common_consul
    deploy:
      replicas: 1
      placement:
        constraints:
          - engine.labels.com.facilitylive.devel==true
      labels:
        traefik.port: 8080
        traefik.frontend.rule: "HostRegexp:{subdomain:.*}.cloud.facilitylive.int;"
        traefik.enable: "true"
        traefik.docker.network: "traefik"
        traefik.frontend.priority: 1

  user:
    image: docker.facilitylive.int/flcloud/fl-cloud-user:1.0.0-SNAPSHOT
    networks:
      - flservice
      - flcloud-common_consulclient
      - traefik
    ports:
      - "8082:8080"
      - "5005:5005"
    secrets:
      - source: authserver_pubkey
        target: /opt/fl-cloud-authserver.pub
    environment:
      - JAVA_OPTS=-Dspring.cloud.consul.host=flcloud-common_consul
    deploy:
      replicas: 1
      placement:
        constraints:
          - engine.labels.com.facilitylive.devel==true
      restart_policy:
        delay: 10s
        window: 10s
      labels:
        traefik.port: 8080
        traefik.frontend.rule: "HostRegexp:{subdomain:.*}.cloud.facilitylive.int; PathPrefixStrip:/api/account; AddPrefix:/fl-user/public"
        traefik.enable: "true"
        traefik.docker.network: "traefik"

  gateway:
    image: docker.facilitylive.int/flcloud/fl-cloud-gateway:1.0.0-SNAPSHOT
    networks:
      - flservice
      - flcloud-common_consulclient
      - traefik
    ports:
      - "8084:8080"
      - "5006:5006"
    secrets:
      - source: authserver_pubkey
        target: /opt/fl-cloud-authserver.pub
    environment:
      - JAVA_OPTS=-Dspring.cloud.consul.host=flcloud-common_consul
    deploy:
      replicas: 1
      placement:
        constraints:
          - engine.labels.com.facilitylive.devel==true
      restart_policy:
        delay: 10s
        window: 10s
      labels:
        traefik.port: 8080
        traefik.frontend.rule: "HostRegexp:{subdomain:.*}.cloud.facilitylive.int; PathPrefixStrip:/api/gateway; AddPrefix:/fl-gateway"
        traefik.enable: "true"
        traefik.docker.network: "traefik"

  eventmanager:
    image: docker.facilitylive.int/flcloud/fl-cloud-eventmanager:1.0.0-SNAPSHOT
    depends_on:
      - cassandra_event_store
    networks:
      - flservice
      - flcloud-common_consulclient
      - traefik
    ports:
      - "8087:8080"
    secrets:
      - source: authserver_privkey
        target: /opt/fl-cloud-eventmanager.jks
    environment:
      - JAVA_OPTS=-Dspring.cloud.consul.host=flcloud-common_consul
    deploy:
      replicas: 1
      placement:
        constraints:
          - engine.labels.com.facilitylive.devel==true
      restart_policy:
        delay: 10s
        window: 10s
      labels:
        traefik.port: 8080
        traefik.frontend.rule: "HostRegexp:{subdomain:.*}.cloud.facilitylive.int; PathPrefixStrip:/api/fl-eventmanager; AddPrefix:/fl-eventmanager"
        traefik.enable: "true"
        traefik.docker.network: "traefik"

  styleguide:
    image: docker.facilitylive.int/flcloud/fl-cloud-styleguide:1.0.0-SNAPSHOT
    ports:
      - "8085:8080"
    networks:
      - flservice
      - flcloud-common_consulclient
    environment:
      - JAVA_OPTS=-Dspring.cloud.consul.host=flcloud-common_consul
    deploy:
      replicas: 1
      placement:
        constraints:
          - engine.labels.com.facilitylive.devel==true
      restart_policy:
        delay: 10s
        window: 10s

  catalog-settings:
    image: docker.facilitylive.int/flcloud/fl-cloud-catalog-settings:1.0.0-SNAPSHOT
    depends_on:
      - redis
    networks:
      - flservice
      - flcloud-common_consulclient
    ports:
      - "8088:8080"
    environment:
      - JAVA_OPTS=-Dspring.cloud.consul.host=flcloud-common_consul
    deploy:
      replicas: 1
      placement:
        constraints:
          - engine.labels.com.facilitylive.devel==true
      restart_policy:
        delay: 10s
        window: 10s

  cassandra_event_store:
    image: cassandra:latest
    networks:
      - flservice
    ports:
      - "9042:9042"
    deploy:
      replicas: 1
      placement:
        constraints:
          - engine.labels.com.facilitylive.devel==true
    environment:
      - CASSANDRA_CLUSTER_NAME=fl-cloud-eventstore
      - JAVA_OPTS=-Dspring.cloud.consul.host=flcloud-common_consul

  couchbase:
    image: docker.facilitylive.int/devops/couchbase:5.0.0
    deploy:
      replicas: 1
      placement:
        constraints:
          - engine.labels.com.facilitylive.devel==true
    networks:
      - flservice
    ports:
      - "8094:8091"
    environment:
      - COUCHBASE_ADMIN_USERNAME=admin
      - COUCHBASE_ADMIN_PASSWORD=password
      - COUCHBASE_BUCKETS=oauth:user

secrets:
  git_privkey:
    external: true
  fl_int_ctr:
    external: true
  fl_int_key:
    external: true
  fl_int_interm:
    external: true
  authserver_privkey:
    external: true
  authserver_pubkey:
    external: true

networks:
  flcloud-common_consulclient:
    external: true
  traefik:
    external: true
  flservice:
    external: false
